<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Etichette ATS 100x100</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<style>
  @page { size: 100mm 100mm; margin:0; }
  body { margin:20px; background:#f0f0f0; font-family:Arial,sans-serif; }
  .no-print { margin-bottom:20px; }
  .btn-stampa {
    background:#007bff; color:white; padding:12px 24px; font-size:16pt;
    border:none; border-radius:5px; cursor:pointer; font-weight:bold;
  }
  .btn-stampa:hover { background:#0056b3; }
 
  .etichetta {
    width:100mm; height:100mm; border:2px solid #000; background:white;
    padding:2mm 3.5mm; box-sizing:border-box; page-break-after:always;
    position:relative; margin-bottom:10mm;
  }
 
  .logo-container { height:10mm; margin-bottom:0.5mm; position:relative; }
  .logo-img { height:9mm; }
  .label-cod-bp {
    position:absolute; right:0; top:12mm;
    font-size:7pt; font-weight:bold; writing-mode:vertical-rl;
    transform:rotate(180deg); letter-spacing:0.3px;
  }
 
  .bp-section { margin-bottom:1mm; }
  .bp-label { font-size:9pt; font-weight:bold; margin-bottom:0.2mm; }
  .bp-value { font-size:20pt; font-weight:bold; line-height:1; }
  .qr-bp { position:absolute; top:11mm; right:9mm; width:11mm; height:11mm; }
 
  hr { border:none; border-top:1.8px solid black; margin:1.2mm 0; }
  hr.thin { border-top:1.8px solid black; margin:1.5mm 0; }
 
  .art-label { font-weight:bold; font-size:9pt; margin:0 0 0.8mm; }
  .barcode-svg { width:72mm; height:26px; margin:0 auto 0.8mm; display:block; }
  .wms { text-align:center; font-size:10.5pt; font-weight:bold; margin-bottom:1mm; }
 
  .po-row { margin-top:1.2mm; margin-bottom:1mm; }
  .po-label { font-size:9pt; font-weight:bold; }
  .po-value { font-size:18pt; font-weight:bold; line-height:1; display:block; }
 
  .label-tpn {
    position:absolute; right:3mm; top:62mm;
    font-size:7pt; font-weight:bold; writing-mode:vertical-rl;
    transform:rotate(180deg); letter-spacing:0.3px;
  }
 
  .part-section { margin:1mm 0 3mm; position:relative; }
  .part-label { font-size:9pt; font-weight:bold; line-height:1.1; }
  .part-value { font-size:16pt; font-weight:bold; line-height:1; display:block; }
  .qr-part { position:absolute; top:0; right:3.5mm; width:11mm; height:11mm; }
 
  /* Serial Number */
  .sn-section {
    position: relative;
    margin: 2mm 0 0.5mm;
  }
  .sn-label { font-size:9pt; font-weight:bold; display:block; }
  .sn-value { font-size:16pt; font-weight:bold; line-height:1.2; display:block; }
  .qr-sn {
    position: absolute;
    top: 0;
    right: 3.5mm;
    width: 11mm;
    height: 11mm;
  }
  /* SN verticale salita di 8px → ora perfetta al centro del QR */
  .label-sn {
    position: absolute;
    right: 0;
    bottom: 2.8mm;          /* salita di 8px rispetto alla versione precedente */
    font-size: 7pt;
    font-weight: bold;
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    letter-spacing: 0.3px;
  }

  /* Ubicazione salita di 8px */
  .ubicazione-under-sn {
    margin-top: -0.5mm;     /* ora è 8px più in alto rispetto a prima */
  }
  .ubicazione-under-sn .pos-label {
    font-size:9pt; font-weight:bold; display:block;
  }
  .ubicazione-under-sn .pos-value {
    font-size:12pt; font-weight:bold; line-height:1.2; word-break:break-all;
  }
 
  @media print {
    body { margin:0; background:white; }
    .no-print { display:none; }
    .etichetta { margin:0; border:2px solid #000; }
  }
</style>
</head>
<body>
<div class="no-print">
  <h2>Etichette ATS 100×100</h2>
  <input type="file" id="excelFile" accept=".xlsx,.xls,.csv">
  <button class="btn-stampa" onclick="window.print()">STAMPA TUTTE</button>
  <button class="btn-stampa" onclick="resetFile()" style="background:#dc3545;">RESET</button>
  <button class="btn-stampa" onclick="downloadTemplate()" style="background:#28a745;">SCARICA TEMPLATE</button>
  <br><br>
</div>
<div id="output"></div>

<script>
function resetFile() {
  document.getElementById('excelFile').value = '';
  document.getElementById('output').innerHTML = '';
}
function downloadTemplate() {
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([
    ['CodiceBP', 'PartNumber', 'SerialNumber/Lotto', 'ArticoloWMS', 'PO', 'Ubicazione'],
    ['000000000302059612', '02310CET', '2102310CET10E5001574', 'WMS0006047-FLM', '471005225', '71-STK-S11-C14-05-003']
  ]);
  XLSX.utils.book_append_sheet(wb, ws, 'Etichette');
  XLSX.writeFile(wb, 'Template_Etichette_ATS.xlsx');
}

document.getElementById('excelFile').addEventListener('change', e => {
  const f = e.target.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = e => {
    const data = e.target.result;
    const wb = XLSX.read(data, {type:'array'});
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
    let html = '';
    for (let i=1; i<rows.length; i++) {
      const CodiceBP     = (rows[i][0]||'').toString().trim();
      const PartNumber   = (rows[i][1]||'').toString().trim();
      const SerialNumber = (rows[i][2]||'').toString().trim();
      const ArticoloWMS  = (rows[i][3]||'').toString().trim();
      const PO           = (rows[i][4]||'').toString().trim();
      const Ubicazione   = (rows[i][5]||'').toString().trim();

      html += `<div class="etichetta">
        <div class="logo-container">
          <img class="logo-img" src="https://raw.githubusercontent.com/Daniele1995-design/WebAppSap/refs/heads/main/logo%20ats.jpg">
          <div class="label-cod-bp">COD BP</div>
        </div>
       
        <div class="bp-section">
          <div class="bp-label">Codice BP</div>
          <div class="bp-value">${CodiceBP}</div>
        </div>
        <img class="qr-bp" src="https://api.qrserver.com/v1/create-qr-code/?size=110x110&data=${encodeURIComponent(CodiceBP)}">
        <hr>
        <div class="art-label">Articolo</div>
        <svg class="barcode-svg" id="bc-${i}"></svg>
        <div class="wms">${ArticoloWMS}</div>
        <hr>

        <div class="po-row">
          <span class="po-label">Po Nr°</span>
          <span class="po-value">${PO}</span>
        </div>

        <div class="label-tpn">TPN</div>
        <hr class="thin">

        <div class="part-section">
          <span class="part-label">Part Number</span>
          <span class="part-value">${PartNumber}</span>
          <img class="qr-part" src="https://api.qrserver.com/v1/create-qr-code/?size=110x110&data=${encodeURIComponent(PartNumber)}">
        </div>
        <hr class="thin">

        <div class="sn-section">
          <span class="sn-label">SerialNumber/Lotto</span>
          <span class="sn-value">${SerialNumber}</span>
          <img class="qr-sn" src="https://api.qrserver.com/v1/create-qr-code/?size=110x110&data=${encodeURIComponent(SerialNumber)}">
          <div class="label-sn">SN</div>
        </div>

        <div class="ubicazione-under-sn">
          <span class="pos-label">Ubicazione</span>
          <div class="pos-value">${Ubicazione}</div>
        </div>

      </div>`;
    }
    document.getElementById('output').innerHTML = html;

    setTimeout(() => {
      for (let i=1; i<rows.length; i++) {
        const val = (rows[i][3]||'').toString().trim();
        if (val && document.getElementById('bc-'+i)) {
          JsBarcode('#bc-'+i, val, {format:"CODE128", height:26, width:1.8, displayValue:false, margin:0});
        }
      }
    }, 300);
  };
  r.readAsArrayBuffer(f);
});
</script>
</body>
</html>

